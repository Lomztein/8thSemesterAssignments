/**
 * generated by Xtext 2.25.0
 */
package dk.sdu.mmmi.mdsd.generator;

import com.google.common.collect.Iterators;
import dk.sdu.mmmi.mdsd.math.Binding;
import dk.sdu.mmmi.mdsd.math.Div;
import dk.sdu.mmmi.mdsd.math.Expression;
import dk.sdu.mmmi.mdsd.math.ExternalCall;
import dk.sdu.mmmi.mdsd.math.ExternalDefinition;
import dk.sdu.mmmi.mdsd.math.LetBinding;
import dk.sdu.mmmi.mdsd.math.MathExp;
import dk.sdu.mmmi.mdsd.math.MathNumber;
import dk.sdu.mmmi.mdsd.math.MathNumberType;
import dk.sdu.mmmi.mdsd.math.Minus;
import dk.sdu.mmmi.mdsd.math.Mult;
import dk.sdu.mmmi.mdsd.math.Parenthesis;
import dk.sdu.mmmi.mdsd.math.Plus;
import dk.sdu.mmmi.mdsd.math.VarBinding;
import dk.sdu.mmmi.mdsd.math.VariableUse;
import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.xtext.generator.AbstractGenerator;
import org.eclipse.xtext.generator.IFileSystemAccess2;
import org.eclipse.xtext.generator.IGeneratorContext;

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
@SuppressWarnings("all")
public class MathGenerator extends AbstractGenerator {
  private static Map<String, Integer> variables;
  
  @Override
  public void doGenerate(final Resource resource, final IFileSystemAccess2 fsa, final IGeneratorContext context) {
    final MathExp math = Iterators.<MathExp>filter(resource.getAllContents(), MathExp.class).next();
    final String className = math.getName();
    final StringBuilder builder = new StringBuilder();
    MathGenerator.generateClass(builder, className, math);
    new File("math_expression").mkdirs();
    fsa.generateFile((className + ".java"), builder.toString());
  }
  
  public static StringBuilder appendLine(final StringBuilder builder, final String string) {
    return builder.append((string + "\n"));
  }
  
  public static void generateClass(final StringBuilder builder, final String className, final MathExp math) {
    MathGenerator.appendLine(builder, (("package math_expression;\nimport java.util.function.IntSupplier;\npublic class " + className) + " {\n"));
    MathGenerator.generateFields(builder, math, 1);
    MathGenerator.appendLine(builder, "\n\tprivate External external;");
    MathGenerator.appendLine(builder, (("\n\tpublic " + className) + "() { }\n"));
    MathGenerator.appendLine(builder, (("\n\tpublic " + className) + "(External external) {\n\t\tthis.external = external;\n\t}\n"));
    final ArrayList<LetBinding> lets = new ArrayList<LetBinding>();
    MathGenerator.generateComputeFunction(builder, math, 1);
    MathGenerator.generateExternalInterface(builder, math, 1);
    MathGenerator.appendLine(builder, "}");
  }
  
  public static void generateFields(final StringBuilder builder, final MathExp math, final int indents) {
    EList<VarBinding> _variables = math.getVariables();
    for (final VarBinding varBinding : _variables) {
      String _asIndents = MathGenerator.asIndents(indents);
      String _plus = (_asIndents + "public int ");
      String _name = varBinding.getName();
      String _plus_1 = (_plus + _name);
      String _plus_2 = (_plus_1 + ";");
      MathGenerator.appendLine(builder, _plus_2);
    }
  }
  
  public static void generateLetExpressions(final StringBuilder builder, final List<LetBinding> lets, final int indents) {
    final ArrayList<LetBinding> cur = new ArrayList<LetBinding>(lets);
    for (final LetBinding binding : cur) {
      lets.remove(binding);
    }
    for (final LetBinding binding_1 : cur) {
      MathGenerator.generateLetExpression(builder, binding_1, indents, lets);
    }
  }
  
  public static void generateLetExpression(final StringBuilder builder, final LetBinding binding, final int indents, final List<LetBinding> lets) {
    final StringBuilder localBuilder = new StringBuilder();
    String _asIndents = MathGenerator.asIndents(indents);
    String _plus = (_asIndents + "int ");
    String _fullyQualifiedName = MathGenerator.fullyQualifiedName(binding);
    String _plus_1 = (_plus + _fullyQualifiedName);
    String _plus_2 = (_plus_1 + " = ");
    String _generateExpression = MathGenerator.generateExpression(binding.getBinding(), builder, indents);
    String _plus_3 = (_plus_2 + _generateExpression);
    String _plus_4 = (_plus_3 + ";");
    MathGenerator.appendLine(builder, _plus_4);
    String _asIndents_1 = MathGenerator.asIndents(indents);
    String _plus_5 = (_asIndents_1 + "int ");
    String _fullyQualifiedName_1 = MathGenerator.fullyQualifiedName(binding);
    String _plus_6 = (_plus_5 + _fullyQualifiedName_1);
    String _plus_7 = (_plus_6 + "return = ");
    String _generateExpression_1 = MathGenerator.generateExpression(binding.getBody(), builder, indents);
    String _plus_8 = (_plus_7 + _generateExpression_1);
    String _plus_9 = (_plus_8 + ";");
    MathGenerator.appendLine(localBuilder, _plus_9);
    int _size = lets.size();
    boolean _greaterThan = (_size > 0);
    if (_greaterThan) {
      MathGenerator.generateLetExpressions(builder, lets, indents);
    }
    builder.append(localBuilder.toString());
  }
  
  public static void generateComputeFunction(final StringBuilder builder, final MathExp math, final int indents) {
    String _asIndents = MathGenerator.asIndents(indents);
    String _plus = (_asIndents + "public void compute () {");
    MathGenerator.appendLine(builder, _plus);
    final StringBuilder localBuilder = new StringBuilder();
    EList<VarBinding> _variables = math.getVariables();
    for (final VarBinding varBinding : _variables) {
      MathGenerator.generateComputeStatement(localBuilder, varBinding, (indents + 1));
    }
    builder.append(localBuilder.toString());
    String _asIndents_1 = MathGenerator.asIndents(indents);
    String _plus_1 = (_asIndents_1 + "}\n");
    MathGenerator.appendLine(builder, _plus_1);
  }
  
  public static void generateComputeStatement(final StringBuilder builder, final VarBinding binding, final int indents) {
    String _asIndents = MathGenerator.asIndents(indents);
    String _name = binding.getName();
    String _plus = (_asIndents + _name);
    String _plus_1 = (_plus + " = ");
    String _generateExpression = MathGenerator.generateExpression(binding.getExpression(), builder, indents);
    String _plus_2 = (_plus_1 + _generateExpression);
    String _plus_3 = (_plus_2 + ";");
    MathGenerator.appendLine(builder, _plus_3);
  }
  
  public static String generateExpression(final Expression exp, final StringBuilder builder, final int indents) {
    String _switchResult = null;
    boolean _matched = false;
    if (exp instanceof Plus) {
      _matched=true;
      String _generateExpression = MathGenerator.generateExpression(((Plus)exp).getLeft(), builder, indents);
      String _plus = (_generateExpression + " + ");
      String _generateExpression_1 = MathGenerator.generateExpression(((Plus)exp).getRight(), builder, indents);
      _switchResult = (_plus + _generateExpression_1);
    }
    if (!_matched) {
      if (exp instanceof Minus) {
        _matched=true;
        String _generateExpression = MathGenerator.generateExpression(((Minus)exp).getLeft(), builder, indents);
        String _plus = (_generateExpression + " - ");
        String _generateExpression_1 = MathGenerator.generateExpression(((Minus)exp).getRight(), builder, indents);
        _switchResult = (_plus + _generateExpression_1);
      }
    }
    if (!_matched) {
      if (exp instanceof Mult) {
        _matched=true;
        String _generateExpression = MathGenerator.generateExpression(((Mult)exp).getLeft(), builder, indents);
        String _plus = (_generateExpression + " * ");
        String _generateExpression_1 = MathGenerator.generateExpression(((Mult)exp).getRight(), builder, indents);
        _switchResult = (_plus + _generateExpression_1);
      }
    }
    if (!_matched) {
      if (exp instanceof Div) {
        _matched=true;
        String _generateExpression = MathGenerator.generateExpression(((Div)exp).getLeft(), builder, indents);
        String _plus = (_generateExpression + " / ");
        String _generateExpression_1 = MathGenerator.generateExpression(((Div)exp).getRight(), builder, indents);
        _switchResult = (_plus + _generateExpression_1);
      }
    }
    if (!_matched) {
      if (exp instanceof Parenthesis) {
        _matched=true;
        String _generateExpression = MathGenerator.generateExpression(((Parenthesis)exp).getExp(), builder, indents);
        String _plus = ("(" + _generateExpression);
        _switchResult = (_plus + ")");
      }
    }
    if (!_matched) {
      if (exp instanceof VariableUse) {
        _matched=true;
        _switchResult = MathGenerator.fullyQualifiedName(((VariableUse)exp).getRef());
      }
    }
    if (!_matched) {
      if (exp instanceof MathNumber) {
        _matched=true;
        _switchResult = Integer.valueOf(((MathNumber)exp).getValue()).toString();
      }
    }
    if (!_matched) {
      if (exp instanceof LetBinding) {
        _matched=true;
        _switchResult = MathGenerator.generateLetBinding(((LetBinding)exp), builder, indents);
      }
    }
    if (!_matched) {
      if (exp instanceof ExternalCall) {
        _matched=true;
        _switchResult = MathGenerator.generateExternalCall(((ExternalCall)exp), builder, indents);
      }
    }
    return _switchResult;
  }
  
  public static String generateLetBinding(final LetBinding binding, final StringBuilder builder, final int indents) {
    String _asIndents = MathGenerator.asIndents(indents);
    String _plus = (_asIndents + "int ");
    String _fullyQualifiedName = MathGenerator.fullyQualifiedName(binding);
    String _plus_1 = (_plus + _fullyQualifiedName);
    String _plus_2 = (_plus_1 + " = ");
    String _generateExpression = MathGenerator.generateExpression(binding.getBinding(), builder, indents);
    String _plus_3 = (_plus_2 + _generateExpression);
    final String prevLine = (_plus_3 + ";");
    int _lastNewLine = MathGenerator.lastNewLine(builder);
    int _plus_4 = (_lastNewLine + 1);
    builder.insert(_plus_4, (prevLine + "\n"));
    return MathGenerator.generateExpression(binding.getBody(), builder, indents);
  }
  
  public static int lastNewLine(final StringBuilder builder) {
    return builder.lastIndexOf("\n");
  }
  
  public static String generateExternalCall(final ExternalCall call, final StringBuilder builder, final int indents) {
    int index = 0;
    final int start = builder.length();
    String _string = builder.toString();
    final StringBuilder localBuilder = new StringBuilder(_string);
    String _name = call.getFunc().getName();
    String _plus = ("this.external." + _name);
    String _plus_1 = (_plus + "(");
    localBuilder.append(_plus_1);
    EList<Expression> _args = call.getArgs();
    for (final Expression arg : _args) {
      {
        index++;
        localBuilder.append(MathGenerator.generateExpression(arg, builder, indents));
        int _size = call.getArgs().size();
        boolean _notEquals = (index != _size);
        if (_notEquals) {
          localBuilder.append(", ");
        }
      }
    }
    localBuilder.append(")");
    return localBuilder.substring(start);
  }
  
  public static String fullyQualifiedName(final Binding binding) {
    String name = binding.getName();
    EObject container = binding.eContainer();
    while ((container != null)) {
      {
        if ((container instanceof Binding)) {
          String _name = name;
          String _name_1 = ((Binding)container).getName();
          name = (_name + _name_1);
        }
        container = container.eContainer();
      }
    }
    return name;
  }
  
  public static void generateExternalInterface(final StringBuilder builder, final MathExp math, final int indents) {
    String _asIndents = MathGenerator.asIndents(indents);
    String _plus = (_asIndents + "public interface External {\n");
    MathGenerator.appendLine(builder, _plus);
    EList<ExternalDefinition> _externals = math.getExternals();
    for (final ExternalDefinition definition : _externals) {
      MathGenerator.generateExternalDefintion(builder, definition, (indents + 1));
    }
    String _asIndents_1 = MathGenerator.asIndents(indents);
    String _plus_1 = ("\n" + _asIndents_1);
    String _plus_2 = (_plus_1 + "}");
    MathGenerator.appendLine(builder, _plus_2);
  }
  
  private static final String argNames = "abcdefghijklmnopqrstuvxyz";
  
  public static void generateExternalDefintion(final StringBuilder builder, final ExternalDefinition definition, final int indents) {
    int index = 0;
    String _asIndents = MathGenerator.asIndents(indents);
    String _plus = (_asIndents + "public int ");
    String _name = definition.getName();
    String _plus_1 = (_plus + _name);
    String _plus_2 = (_plus_1 + "(");
    builder.append(_plus_2);
    EList<MathNumberType> _params = definition.getParams();
    for (final MathNumberType param : _params) {
      {
        int _plusPlus = index++;
        final char name = MathGenerator.argNames.charAt(_plusPlus);
        String _string = param.toString();
        String _plus_3 = (_string + " ");
        String _plus_4 = (_plus_3 + Character.valueOf(name));
        builder.append(_plus_4);
        int _size = definition.getParams().size();
        boolean _notEquals = (index != _size);
        if (_notEquals) {
          builder.append(", ");
        }
      }
    }
    builder.append(");\n");
  }
  
  public static String asIndents(final int num) {
    final StringBuilder builder = new StringBuilder((num * 2));
    for (int i = 0; (i < num); i++) {
      builder.append("\t");
    }
    return builder.toString();
  }
}
